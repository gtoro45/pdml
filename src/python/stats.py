import matplotlib.pyplot as plt

# Data
lines_read = [
    200,400,600,800,1000,1200,1400,1600,1800,2000,2200,2400,2600,2800,3000,3200,3400,3600,3800,4000,
    4200,4400,4600,4800,5000,5200,5400,5600,5800,6000,6200,6400,6600,6800,7000,7200,7400,7600,7800,8000,
    8200,8400,8600,8800,9000,9200,9400,9600,9800,10000,10200,10400,10600,10800,11000,11200,11400,11600,11800,
    12000,12200,12400,12600,12800,13000,13200,13400,13600,13800,14000,14200,14400,14600,14800,15000,15200,15400,
    15600,15800,16000,16200,16400,16600,16800,17000,17200,17400,17600,17800,18000,18200,18400,18600,18800,19000,
    19200,19400,19600,19800,20000,20200,20400,20600,20800,21000,21200,21400,21600,21800,22000,22200,22400,22600,
    22800,23000,23200,23400,23600,23800,24000,24200
]

values = [
    0.007849098183214664,0.008658237755298615,0.008347730152308941,0.009250467643141747,0.008685952983796597,
    0.008570408448576927,0.009552679024636745,0.008950762450695038,0.00829901173710823,0.008306294679641724,
    0.009872338734567165,0.009015192277729511,0.009250467643141747,0.008857492357492447,0.009552679024636745,
    0.00829901173710823,0.008950762450695038,0.008570408448576927,0.009552679024636745,0.009250467643141747,
    0.009552679024636745,0.008570408448576927,0.9526669383049011,0.966195285320282,0.9626114368438721,
    0.9650628566741943,0.9672114253044128,0.9611769914627075,0.9650628566741943,0.9611769914627075,
    0.963615357875824,0.9637773036956787,0.9626114368438721,0.9650628566741943,0.9650628566741943,
    0.9650628566741943,0.9672114253044128,0.9672114253044128,0.9610024690628052,0.9610024690628052,
    0.9493914246559143,0.007799886167049408,0.007799886167049408,0.008061369881033897,0.008061369881033897,
    0.007799886167049408,0.007799886167049408,0.007799886167049408,0.008061369881033897,0.007441455498337746,
    0.007691016886383295,0.007691016886383295,0.007441455498337746,0.007691016886383295,0.007441455498337746,
    0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007441455498337746,
    0.007441455498337746,0.007691016886383295,0.007441455498337746,0.007691016886383295,0.007691016886383295,
    0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007691016886383295,
    0.007441455498337746,0.007691016886383295,0.007441455498337746,0.007441455498337746,0.007441455498337746,
    0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007441455498337746,
    0.007441455498337746,0.007441455498337746,0.007942689582705498,0.007441455498337746,0.007441455498337746,
    0.007441455498337746,0.007441455498337746,0.007942689582705498,0.007441455498337746,0.007441455498337746,
    0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007942689582705498,
    0.007942689582705498,0.007942689582705498,0.007691016886383295,0.007691016886383295,0.007691016886383295,
    0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007441455498337746,0.007441455498337746,
    0.007441455498337746,0.007441455498337746,0.008573370985686779,0.007691016886383295,0.007691016886383295,
    0.007691016886383295,0.007691016886383295,0.007567469030618668,0.007441455498337746,0.007441455498337746,
    0.007691016886383295,0.007942689582705498,0.007691016886383295,0.007441455498337746,0.007441455498337746,
    0.007691016886383295,0.007942689582705498
]

# Trim to same length
values = values[:len(lines_read)]

# Plot
plt.figure(figsize=(12,5))
plt.plot(lines_read, values)
plt.title("Window Anomaly Score [len(window)=200]")
plt.xlabel("Lines read")
plt.ylabel("Anomaly prediction")
plt.grid(True)
plt.show()

num_anomalous_transactions = 3503 - 8
total_transactions = 24329 - 8
print(f"Expected % Anomalous Traffic = {100 * (num_anomalous_transactions / total_transactions):.3f}%")

anomalous_windows = 0
for val in values:
    if val > 0.5:
        anomalous_windows += 1
print(f"Actual % Anomalous Traffic = {100* (anomalous_windows / len(values)):.3f}%")

# import time
# import threading
# import numpy as np

# def follow(path):
#     f = open(path)
#     f.seek(0, 2)
#     while True:
#         line = f.readline()
#         if not line:
#             time.sleep(0.01)
#             continue
#         yield line

# source_times = {}

# def extract_uid(line, uid_idx, sep):
#     parts = line.split(sep)
#     if len(parts) <= uid_idx:
#         return None
#     return parts[uid_idx]

# # -----------------------------
# # CONFIGURE YOUR FORMATS HERE
# # -----------------------------
# SRC_UID_IDX  = 1      # example: column # in file1.log
# DST_UID_IDX  = 2      # example: column # in file2.log 
# SRC_SEP      = '\x09'       # separator for file1.log
# DST_SEP      = ','          # separator for file2.log
# SRC_PATH     = "../../train_test_data/demo/conn.log"
# DST_PATH     = "../../buf/demo_buf.csv"
# # -----------------------------


# def track_source():
#     for line in follow(SRC_PATH):
#         uid = extract_uid(line, SRC_UID_IDX, SRC_SEP)
#         if uid is not None:
#             source_times[uid] = time.time()


# latencies = []

# def track_output():
#     for line in follow(DST_PATH):
#         uid = extract_uid(line, DST_UID_IDX, DST_SEP)
#         if uid is None:
#             continue
#         if uid in source_times:
#             latency = time.time() - source_times[uid]
#             latencies.append(latency)
#             print(f"Avg Latency Added (n={len(latencies)}): {(np.mean(latencies)) * 1000:5f} +/- {(np.std(latencies)) * 1000:.5f}")
#             # print(f"UID {uid}: latency {latency*1000:.2f} ms")


# threading.Thread(target=track_source, daemon=True).start()
# track_output()

